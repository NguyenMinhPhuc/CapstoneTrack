/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a role-based access control model for the CapstoneTrack application.
 *
 * Data Structure:
 * - /users/{userId}: User account information; owner-only access.
 * - /students/{studentId}: Student profiles; public read, owner-only writes.
 * - /supervisors/{supervisorId}: Supervisor profiles; public read, owner-only writes.
 * - /defenseSessions/{sessionId}: Defense session details; public read, restricted writes.
 * - /defenseRegistrations/{registrationId}: Student registrations for defense sessions; public read, restricted writes.
 * - /defenseSessions/{sessionId}/council/{councilMemberId}: Defense council members; public read, restricted writes.
 * - /defenseSessions/{sessionId}/subCommittees/{subCommitteeId}: Defense sub-committees; public read, restricted writes.
 * - /projectTopics/{topicId}: Project topics proposed by supervisors; public read, restricted writes.
 * - /rubrics/{rubricId}: Grading rubric templates; public read, restricted writes.
 * - /evaluations/{evaluationId}: Supervisor evaluations; public read, restricted writes.
 * - /weeklyProgressReports/{reportId}: Student weekly progress reports; owner-only access.
 * - /systemSettings/{settingId}: System-wide settings; restricted access.
 * - /internshipCompanies/{companyId}: Internship company information; public read, restricted writes.
 * - /earlyInternships/{internshipId}: Early internship records; public read, restricted writes.
 * - /earlyInternshipWeeklyReports/{reportId}: Early internship weekly progress reports; owner-only access.
 * - /conversations/{conversationId}: Q&A conversation threads; shared access based on participantIds.
 * - /conversations/{conversationId}/messages/{messageId}: Messages within conversations; shared access based on participantIds.
 * - /notifications/{notificationId}: Notifications for users; owner-only access.
 *
 * Key Security Decisions:
 * - User listing is generally disallowed for privacy.
 * - Public read access is granted to several top-level collections (e.g., students, supervisors, defenseSessions) to facilitate data discovery.
 * - Write access is generally restricted to owners or authorized roles.
 * - Data validation is minimized to allow for rapid prototyping, but authorization-critical fields are validated.
 *
 * Denormalization for Authorization:
 * - The `conversations` and `messages` collections use a `participantIds` array on each document to enable efficient authorization checks for shared access.
 *
 * Structural Segregation:
 * - Private user data is stored under the `/users/{userId}` path, ensuring owner-only access.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the current user is signed in.
     * @param None
     * @return {bool} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the current user is the owner of the resource, based on the provided userId.
     * @param {string} userId The user ID to compare with the request's auth UID.
     * @return {bool} True if the user is the owner, false otherwise.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the current user is the owner of the resource, and also verifies that the resource exists.
     *              This function is used for update and delete operations to prevent acting on non-existent documents.
     * @param {string} userId The user ID to compare with the resource's owner ID.
     * @return {bool} True if the user is the owner and the resource exists, false otherwise.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Checks if the current user is a participant in a shared resource (e.g., a conversation).
     * @param {array} participantIds An array of user IDs who are participants in the resource.
     * @return {bool} True if the user is a participant, false otherwise.
     */
    function isParticipant(participantIds) {
      return isSignedIn() && participantIds.hasAny([request.auth.uid]);
    }

    /**
     * @description Rules for the /users/{userId} collection.
     * @path /users/{userId}
     * @allow (create) - User with ID 'user123' creates their own account.
     *   - Auth: { uid: 'user123' }
     *   - Request: { "id": "user123", "email": "test@example.com", "role": "student", "status": "pending" }
     * @allow (get, list, update, delete) - User with ID 'user123' reads, updates, or deletes their own account.
     *   - Auth: { uid: 'user123' }
     * @deny (create) - User with ID 'user456' attempts to create an account for 'user123'.
     *   - Auth: { uid: 'user456' }
     *   - Request: { "id": "user123", "email": "test@example.com", "role": "student", "status": "pending" }
     * @deny (get, list, update, delete) - User with ID 'user456' attempts to read, update, or delete 'user123's account.
     *   - Auth: { uid: 'user456' }
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false; // Prevent listing of all users.
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for the /students/{studentId} collection.
     * @path /students/{studentId}
     * @allow (get, list) - Any signed-in user can read student profiles.
     *   - Auth: { uid: 'user123' }
     * @allow (create) - User with ID 'student123' creates their own student profile.
     *   - Auth: { uid: 'student123' }
     *   - Request: { "id": "student123", "studentId": "12345", "firstName": "John", "lastName": "Doe", "major": "CS", "enrollmentYear": 2023, "status": "studying" }
     * @allow (update, delete) - User with ID 'student123' updates or deletes their own student profile.
     *   - Auth: { uid: 'student123' }
     * @deny (create) - User with ID 'user456' attempts to create a student profile for 'student123'.
     *   - Auth: { uid: 'user456' }
     *   - Request: { "id": "student123", "studentId": "12345", "firstName": "John", "lastName": "Doe", "major": "CS", "enrollmentYear": 2023, "status": "studying" }
     * @deny (update, delete) - User with ID 'user456' attempts to update or delete 'student123's student profile.
     *   - Auth: { uid: 'user456' }
     * @principle Public read, owner-only writes.
     */
    match /students/{studentId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.id == studentId;
      allow update: if isExistingOwner(studentId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(studentId);
    }

    /**
     * @description Rules for the /supervisors/{supervisorId} collection.
     * @path /supervisors/{supervisorId}
     * @allow (get, list) - Any signed-in user can read supervisor profiles.
     *   - Auth: { uid: 'user123' }
     * @allow (create) - User with ID 'supervisor123' creates their own supervisor profile.
     *   - Auth: { uid: 'supervisor123' }
     *   - Request: { "id": "supervisor123", "firstName": "Jane", "lastName": "Smith", "department": "CS" }
     * @allow (update, delete) - User with ID 'supervisor123' updates or deletes their own supervisor profile.
     *   - Auth: { uid: 'supervisor123' }
     * @deny (create) - User with ID 'user456' attempts to create a supervisor profile for 'supervisor123'.
     *   - Auth: { uid: 'user456' }
     *   - Request: { "id": "supervisor123", "firstName": "Jane", "lastName": "Smith", "department": "CS" }
     * @deny (update, delete) - User with ID 'user456' attempts to update or delete 'supervisor123's supervisor profile.
     *   - Auth: { uid: 'user456' }
     * @principle Public read, owner-only writes.
     */
    match /supervisors/{supervisorId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.id == supervisorId;
      allow update: if isExistingOwner(supervisorId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(supervisorId);
    }

    /**
     * @description Rules for the /defenseSessions/{sessionId} collection.
     * @path /defenseSessions/{sessionId}
     * @allow (get, list) - Any signed-in user can read defense session information.
     *   - Auth: { uid: 'user123' }
     * @deny (create, update, delete) - No one can create, update, or delete defense sessions in this prototype.
     *   - Auth: { uid: 'user123' }
     * @principle Public read, restricted writes (TODO: Add role-based write access).
     */
    match /defenseSessions/{sessionId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add role-based write access
    }

    /**
     * @description Rules for the /defenseRegistrations/{registrationId} collection.
     * @path /defenseRegistrations/{registrationId}
     * @allow (get, list) - Any signed-in user can read defense registration information.
     *   - Auth: { uid: 'user123' }
     * @deny (create, update, delete) - No one can create, update, or delete defense registrations in this prototype.
     *   - Auth: { uid: 'user123' }
     * @principle Public read, restricted writes (TODO: Add role-based write access).
     */
    match /defenseRegistrations/{registrationId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add role-based write access
    }

    /**
     * @description Rules for the /defenseSessions/{sessionId}/council/{councilMemberId} collection.
     * @path /defenseSessions/{sessionId}/council/{councilMemberId}
     * @allow (get, list) - Any signed-in user can read defense council member information.
     *   - Auth: { uid: 'user123' }
     * @deny (create, update, delete) - No one can create, update, or delete defense council members in this prototype.
     *   - Auth: { uid: 'user123' }
     * @principle Public read, restricted writes (TODO: Add role-based write access).
     */
    match /defenseSessions/{sessionId}/council/{councilMemberId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add role-based write access
    }

    /**
     * @description Rules for the /defenseSessions/{sessionId}/subCommittees/{subCommitteeId} collection.
     * @path /defenseSessions/{sessionId}/subCommittees/{subCommitteeId}
     * @allow (get, list) - Any signed-in user can read defense sub-committee information.
     *   - Auth: { uid: 'user123' }
     * @deny (create, update, delete) - No one can create, update, or delete defense sub-committees in this prototype.
     *   - Auth: { uid: 'user123' }
     * @principle Public read, restricted writes (TODO: Add role-based write access).
     */
    match /defenseSessions/{sessionId}/subCommittees/{subCommitteeId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add role-based write access
    }

    /**
     * @description Rules for the /projectTopics/{topicId} collection.
     * @path /projectTopics/{topicId}
     * @allow (get, list) - Any signed-in user can read project topic information.
     *   - Auth: { uid: 'user123' }
     * @deny (create, update, delete) - No one can create, update, or delete project topics in this prototype.
     *   - Auth: { uid: 'user123' }
     * @principle Public read, restricted writes (TODO: Add role-based write access).
     */
    match /projectTopics/{topicId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add role-based write access
    }

    /**
     * @description Rules for the /rubrics/{rubricId} collection.
     * @path /rubrics/{rubricId}
     * @allow (get, list) - Any signed-in user can read rubric information.
     *   - Auth: { uid: 'user123' }
     * @deny (create, update, delete) - No one can create, update, or delete rubrics in this prototype.
     *   - Auth: { uid: 'user123' }
     * @principle Public read, restricted writes (TODO: Add role-based write access).
     */
    match /rubrics/{rubricId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add role-based write access
    }

    /**
     * @description Rules for the /evaluations/{evaluationId} collection.
     * @path /evaluations/{evaluationId}
     * @allow (get, list) - Any signed-in user can read evaluation information.
     *   - Auth: { uid: 'user123' }
     * @deny (create, update, delete) - No one can create, update, or delete evaluations in this prototype.
     *   - Auth: { uid: 'user123' }
     * @principle Public read, restricted writes (TODO: Add role-based write access).
     */
    match /evaluations/{evaluationId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add role-based write access
    }

    /**
     * @description Rules for the /weeklyProgressReports/{reportId} collection.
     * @path /weeklyProgressReports/{reportId}
     * @allow (get) - User with ID 'user123' can read their own weekly progress report.
     *   - Auth: { uid: 'user123' }
     * @allow (list) - User with ID 'user123' can list their own weekly progress reports.
     *   - Auth: { uid: 'user123' }
     * @allow (create) - User with ID 'user123' can create their own weekly progress report.
     *   - Auth: { uid: 'user123' }
     *   - Request: { "id": "report123", "registrationId": "reg456", "studentId": "user123", "supervisorId": "sup789", "sessionId": "session1", "weekNumber": 1, "submissionDate": "2024-01-01T00:00:00Z", "workDone": "Completed task A", "nextWeekPlan": "Start task B", "status": "pending_review" }
     * @allow (update, delete) - User with ID 'user123' can update or delete their own weekly progress report.
     *   - Auth: { uid: 'user123' }
     * @deny (get, list, create, update, delete) - User with ID 'user456' attempts to access 'user123's weekly progress reports.
     *   - Auth: { uid: 'user456' }
     * @principle Enforces document ownership for all operations.
     */
    match /weeklyProgressReports/{reportId} {
      allow get: if get(/defenseRegistrations/$(request.resource.data.registrationId)).data.studentDocId == request.auth.uid;
      allow list: if isSignedIn(); // TODO: restrict to user's own reports using query
      allow create: if isSignedIn() && request.resource.data.studentId == request.auth.uid;
      allow update: if get(/defenseRegistrations/$(request.resource.data.registrationId)).data.studentDocId == request.auth.uid && resource != null;
      allow delete: if get(/defenseRegistrations/$(request.resource.data.registrationId)).data.studentDocId == request.auth.uid && resource != null;
    }

    /**
     * @description Rules for the /systemSettings/{settingId} collection.
     * @path /systemSettings/{settingId}
     * @allow get: if true;
     * @allow list: if false; // Prevent listing of all system settings.
     * @deny create, update, delete: if true; // No one can create, update, or delete system settings in this prototype.
     * @principle Public read, restricted writes (TODO: Add admin-only write access).
     */
    match /systemSettings/{settingId} {
      allow get: if true;
      allow list: if false;
      allow create, update, delete: if false; // TODO: Add admin-only write access
    }

    /**
     * @description Rules for the /internshipCompanies/{companyId} collection.
     * @path /internshipCompanies/{companyId}
     * @allow (get, list) - Any signed-in user can read internship company information.
     *   - Auth: { uid: 'user123' }
     * @deny (create, update, delete) - No one can create, update, or delete internship companies in this prototype.
     *   - Auth: { uid: 'user123' }
     * @principle Public read, restricted writes (TODO: Add role-based write access).
     */
    match /internshipCompanies/{companyId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add role-based write access
    }

    /**
     * @description Rules for the /earlyInternships/{internshipId} collection.
     * @path /earlyInternships/{internshipId}
     * @allow (get, list) - Any signed-in user can read early internship information.
     *   - Auth: { uid: 'user123' }
     * @deny (create, update, delete) - No one can create, update, or delete early internships in this prototype.
     *   - Auth: { uid: 'user123' }
     * @principle Public read, restricted writes (TODO: Add role-based write access).
     */
    match /earlyInternships/{internshipId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add role-based write access
    }

    /**
     * @description Rules for the /earlyInternshipWeeklyReports/{reportId} collection.
     * @path /earlyInternshipWeeklyReports/{reportId}
     * @allow (get) - User with ID 'user123' can read their own early internship weekly report.
     *   - Auth: { uid: 'user123' }
     * @allow (list) - User with ID 'user123' can list their own early internship weekly reports.
     *   - Auth: { uid: 'user123' }
     * @allow (create) - User with ID 'user123' can create their own early internship weekly report.
     *   - Auth: { uid: 'user123' }
     *   - Request: { "id": "report123", "earlyInternshipId": "internship456", "studentId": "user123", "supervisorId": "sup789", "weekNumber": 1, "hours": 40, "reviewDate": "2024-01-01T00:00:00Z", "status": "pending_review" }
     * @allow (update, delete) - User with ID 'user123' can update or delete their own early internship weekly report.
     *   - Auth: { uid: 'user123' }
     * @deny (get, list, create, update, delete) - User with ID 'user456' attempts to access 'user123's early internship weekly reports.
     *   - Auth: { uid: 'user456' }
     * @principle Enforces document ownership for all operations.
     */
    match /earlyInternshipWeeklyReports/{reportId} {
      allow get: if request.auth.uid == resource.data.studentId;
      allow list: if false; // Prevent listing of all reports.
      allow create: if request.auth.uid == request.resource.data.studentId;
      allow update: if request.auth.uid == resource.data.studentId && resource != null;
      allow delete: if request.auth.uid == resource.data.studentId && resource != null;
    }

    /**
     * @description Rules for the /conversations/{conversationId} collection.
     * @path /conversations/{conversationId}
     * @allow (get, list) - User can read/list conversations if they are a participant.
     *   - Auth: { uid: 'user123' }
     *   - Data: { participantIds: ['user123', 'user456'] }
     * @allow (create) - User can create a conversation if they are in participantIds.
     *   - Auth: { uid: 'user123' }
     *   - Request: { participantIds: ['user123', 'user456'] }
     * @allow (update) - User can update conversation if they are in participantIds and the document exists.
     *   - Auth: { uid: 'user123' }
     *   - Data: { participantIds: ['user123', 'user456'] }
     * @allow (delete) - User can delete the conversation if they are in participantIds and the document exists.
     *   - Auth: { uid: 'user123' }
     *   - Data: { participantIds: ['user123', 'user456'] }
     * @deny (get, list, create, update, delete) - User tries to access a conversation where they are not a participant.
     *   - Auth: { uid: 'user789' }
     *   - Data: { participantIds: ['user123', 'user456'] }
     * @principle Enforces shared access based on participantIds.
     */
    match /conversations/{conversationId} {
      allow get: if isParticipant(resource.data.participantIds);
      allow list: if isSignedIn(); //TODO: restrict by query
      allow create: if isSignedIn() && request.resource.data.participantIds.hasAny([request.auth.uid]);
      allow update: if isParticipant(resource.data.participantIds) && resource != null;
      allow delete: if isParticipant(resource.data.participantIds) && resource != null;
    }

    /**
     * @description Rules for the /conversations/{conversationId}/messages/{messageId} collection.
     * @path /conversations/{conversationId}/messages/{messageId}
     * @allow (get, list) - User can read/list messages in a conversation if they are a participant in the conversation.
     *   - Auth: { uid: 'user123' }
     *   - Parent Data: { participantIds: ['user123', 'user456'] }
     * @allow (create) - User can create a message if they are a participant in the conversation.
     *   - Auth: { uid: 'user123' }
     *   - Parent Data: { participantIds: ['user123', 'user456'] }
     *   - Request: { conversationId: 'conversation123', senderId: 'user123', content: 'Hello!' }
     * @deny (get, list, create, update, delete) - User tries to access messages in a conversation where they are not a participant.
     *   - Auth: { uid: 'user789' }
     *   - Parent Data: { participantIds: ['user123', 'user456'] }
     * @principle Enforces shared access based on participantIds inherited from the parent conversation.
     */
    match /conversations/{conversationId}/messages/{messageId} {
      allow get: if get(/conversations/$(conversationId)).data.participantIds.hasAny([request.auth.uid]);
      allow list: if isSignedIn(); //TODO: restrict by query
      allow create: if isSignedIn() && request.resource.data.senderId == request.auth.uid;
      allow update, delete: if false; // Messages cannot be updated or deleted once created.
    }

    /**
     * @description Rules for the /notifications/{notificationId} collection.
     * @path /notifications/{notificationId}
     * @allow (get) - User can read their own notification.
     *   - Auth: { uid: 'user123' }
     *   - Data: { recipientId: 'user123' }
     * @allow (list) - User can list their own notifications.
     *   - Auth: { uid: 'user123' }
     * @allow (create) - A user can create notification if they are the intended recipient.
     *   - Auth: { uid: 'user123' }
     *   - Request: { recipientId: 'user123' }
     * @allow (update) - User can update their own notification.
     *   - Auth: { uid: 'user123' }
     *   - Data: { recipientId: 'user123' }
     * @allow (delete) - User can delete their own notification.
     *   - Auth: { uid: 'user123' }
     *   - Data: { recipientId: 'user123' }
     * @deny (get, list, create, update, delete) - User tries to access notifications not intended for them.
     *   - Auth: { uid: 'user456' }
     *   - Data: { recipientId: 'user123' }
     * @principle Enforces owner-only access based on recipientId.
     */
    match /notifications/{notificationId} {
      allow get: if request.auth.uid == resource.data.recipientId;
      allow list: if isSignedIn(); //TODO: restrict by query
      allow create: if request.resource.data.recipientId == request.auth.uid;
      allow update: if request.auth.uid == resource.data.recipientId && resource != null;
      allow delete: if request.auth.uid == resource.data.recipientId && resource != null;
    }
  }
}