/**
 * @file Firebase Security Rules for CapstoneTrack Firestore database.
 *
 * Core Philosophy:
 * This ruleset prioritizes secure authorization based on user roles and resource ownership.
 * It aims to prevent unauthorized data access and modification while providing a flexible
 * data structure for rapid prototyping. Data shape validation is intentionally relaxed
 * to allow for faster iteration during development.
 *
 * Data Structure:
 * The database uses a top-level collection structure for entities like users, students,
 * supervisors, defense sessions, and registrations.  Subcollections are used to nest
 * related data (e.g. defense council, subcommittees, and project topics within defense sessions).
 *
 * Key Security Decisions:
 * - User listing is generally disallowed to protect privacy.
 * - Public read access is granted only to explicitly public collections.
 * - All write operations are protected by authorization checks based on roles and ownership.
 * - All update and delete operations will verify that the document exists before proceeding.
 *
 * Denormalization for Authorization:
 * Authorization decisions rely on the authenticated user's UID (`request.auth.uid`).
 * To avoid complex `get()` calls in the rules, data required for authorization (e.g., ownership,
 * roles, member lists) MUST be denormalized (copied) directly onto the secured documents.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the user is signed in.
     * @path N/A
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user's ID matches the provided userId.
     * @path N/A
     * @param {string} userId - The user ID to compare against the authenticated user's ID.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

     /**
      * @description Checks if the authenticated user's ID matches the provided userId and the resource exists.
      * @path N/A
      * @param {string} userId - The user ID to compare against the authenticated user's ID.
      */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Checks if the user has the 'admin' role.
     * @path N/A
     */
    function isAdmin() {
        return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    /**
     * @description Matches the /users/{userId} collection.
     * @path /users/{userId}
     * @allow (create) - If the user is creating their own document.
     * @deny (create) - If the user is trying to create a document for another user.
     * @allow (get, list, update, delete) - If the user is the owner of the document or is an admin.
     * @deny (get, list, update, delete) - If the user is not the owner and not an admin.
     * @principle Enforces user-ownership for user accounts.
     */
    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if false; // Do not allow listing all users.
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) || isAdmin();
      allow delete: if isExistingOwner(userId) || isAdmin();
    }

    /**
     * @description Matches the /students/{studentId} collection.
     * @path /students/{studentId}
     * @allow (create) - Only admins can create student profiles.
     * @deny (create) - Non-admins cannot create student profiles.
     * @allow (get, list, update, delete) - If the user is an admin.
     * @deny (get, list, update, delete) - If the user is not an admin.
     * @principle Restricts student profile management to admins.
     */
    match /students/{studentId} {
      allow get: if isAdmin();
      allow list: if isAdmin();
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Matches the /supervisors/{supervisorId} collection.
     * @path /supervisors/{supervisorId}
     * @allow (create) - Only admins can create supervisor profiles.
     * @deny (create) - Non-admins cannot create supervisor profiles.
     * @allow (get, list, update, delete) - If the user is an admin.
     * @deny (get, list, update, delete) - If the user is not an admin.
     * @principle Restricts supervisor profile management to admins.
     */
    match /supervisors/{supervisorId} {
      allow get: if isAdmin();
      allow list: if isAdmin();
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Matches the /defenseSessions/{sessionId} collection.
     * @path /defenseSessions/{sessionId}
     * @allow (create) - Only admins can create defense sessions.
     * @deny (create) - Non-admins cannot create defense sessions.
     * @allow (get, list, update, delete) - If the user is an admin.
     * @deny (get, list, update, delete) - If the user is not an admin.
     * @principle Restricts defense session management to admins.
     */
    match /defenseSessions/{sessionId} {
      allow get: if isAdmin();
      allow list: if isAdmin();
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Matches the /defenseRegistrations/{registrationId} collection.
     * @path /defenseRegistrations/{registrationId}
     * @allow (create) - Only admins can create defense registrations.
     * @deny (create) - Non-admins cannot create defense registrations.
     * @allow (get, list, update, delete) - If the user is an admin.
     * @deny (get, list, update, delete) - If the user is not an admin.
     * @principle Restricts defense registration management to admins.
     */
    match /defenseRegistrations/{registrationId} {
      allow get: if isAdmin();
      allow list: if isAdmin();
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Matches the /defenseSessions/{sessionId}/council/{councilMemberId} collection.
     * @path /defenseSessions/{sessionId}/council/{councilMemberId}
     * @allow (create) - Only admins can create council members.
     * @deny (create) - Non-admins cannot create council members.
     * @allow (get, list, update, delete) - If the user is an admin.
     * @deny (get, list, update, delete) - If the user is not an admin.
     * @principle Restricts defense council management to admins.
     */
    match /defenseSessions/{sessionId}/council/{councilMemberId} {
      allow get: if isAdmin();
      allow list: if isAdmin();
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Matches the /defenseSessions/{sessionId}/subCommittees/{subCommitteeId} collection.
     * @path /defenseSessions/{sessionId}/subCommittees/{subCommitteeId}
     * @allow (create) - Only admins can create subcommittees.
     * @deny (create) - Non-admins cannot create subcommittees.
     * @allow (get, list, update, delete) - If the user is an admin.
     * @deny (get, list, update, delete) - If the user is not an admin.
     * @principle Restricts defense subcommittee management to admins.
     */
    match /defenseSessions/{sessionId}/subCommittees/{subCommitteeId} {
      allow get: if isAdmin();
      allow list: if isAdmin();
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Matches the /projectTopics/{topicId} collection.
     * @path /projectTopics/{topicId}
     * @allow (create) - Only admins can create project topics.
     * @deny (create) - Non-admins cannot create project topics.
     * @allow (get, list, update, delete) - If the user is an admin.
     * @deny (get, list, update, delete) - If the user is not an admin.
     * @principle Restricts project topic management to admins.
     */
    match /projectTopics/{topicId} {
      allow get: if isAdmin();
      allow list: if isAdmin();
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Matches the /rubrics/{rubricId} collection.
     * @path /rubrics/{rubricId}
     * @allow (create) - Only admins can create rubrics.
     * @deny (create) - Non-admins cannot create rubrics.
     * @allow (get, list, update, delete) - If the user is an admin.
     * @deny (get, list, update, delete) - If the user is not an admin.
     * @principle Restricts rubric management to admins.
     */
    match /rubrics/{rubricId} {
      allow get: if isAdmin();
      allow list: if isAdmin();
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Matches the /evaluations/{evaluationId} collection.
     * @path /evaluations/{evaluationId}
     * @allow (create) - Only admins can create evaluations.
     * @deny (create) - Non-admins cannot create evaluations.
     * @allow (get, list, update, delete) - If the user is an admin.
     * @deny (get, list, update, delete) - If the user is not an admin.
     * @principle Restricts evaluation management to admins.
     */
    match /evaluations/{evaluationId} {
      allow get: if isAdmin();
      allow list: if isAdmin();
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Matches the /weeklyProgressReports/{reportId} collection.
     * @path /weeklyProgressReports/{reportId}
     * @allow (create) - Only admins can create weekly progress reports.
     * @deny (create) - Non-admins cannot create weekly progress reports.
     * @allow (get, list, update, delete) - If the user is an admin.
     * @deny (get, list, update, delete) - If the user is not an admin.
     * @principle Restricts weekly progress report management to admins.
     */
    match /weeklyProgressReports/{reportId} {
      allow get: if isAdmin();
      allow list: if isAdmin();
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Matches the /systemSettings/{settingId} collection.
     * @path /systemSettings/{settingId}
     * @allow (get, list, create, update, delete) - Only admins can manage settings.
     * @deny (get, list, create, update, delete) - Non-admins cannot manage settings.
     * @principle Restricts system settings management to admins.
     */
    match /systemSettings/{settingId} {
      allow get: if isAdmin();
      allow list: if isAdmin();
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Matches the /internshipCompanies/{companyId} collection.
     * @path /internshipCompanies/{companyId}
     * @allow (get, list, create, update, delete) - Only admins can manage companies.
     * @deny (get, list, create, update, delete) - Non-admins cannot manage companies.
     * @principle Restricts internship company management to admins.
     */
    match /internshipCompanies/{companyId} {
      allow get: if isAdmin();
      allow list: if isAdmin();
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Matches the /earlyInternships/{internshipId} collection.
     * @path /earlyInternships/{internshipId}
     * @allow (get, list, create, update, delete) - Only admins can manage early internships.
     * @deny (get, list, create, update, delete) - Non-admins cannot manage early internships.
     * @principle Restricts early internship management to admins.
     */
    match /earlyInternships/{internshipId} {
      allow get: if isAdmin();
      allow list: if isAdmin();
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Matches the /earlyInternshipWeeklyReports/{reportId} collection.
     * @path /earlyInternshipWeeklyReports/{reportId}
     * @allow (get, list, create, update, delete) - Only admins can manage early internship weekly reports.
     * @deny (get, list, create, update, delete) - Non-admins cannot manage early internship weekly reports.
     * @principle Restricts early internship weekly report management to admins.
     */
    match /earlyInternshipWeeklyReports/{reportId} {
      allow get: if isAdmin();
      allow list: if isAdmin();
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Matches the /conversations/{conversationId} collection.
     * @path /conversations/{conversationId}
     * @allow (get, create, update) - if the user is a participant.
     * @allow (list) - if the user is a participant
     * @deny (delete) - No one can delete a conversation.
     * @principle Restricts conversation access to participants.
     */
    match /conversations/{conversationId} {
      function isParticipant() {
        return request.auth.uid in resource.data.participantIds;
      }

      allow get: if isSignedIn() && isParticipant();
      allow list: if isSignedIn() && true; // TODO: Limit this to conversations where the user is a participant.
      allow create: if isSignedIn(); // TODO: Limit to include validation to ensure the user is a participant.
      allow update: if isSignedIn() && isParticipant() && resource != null;
      allow delete: if false;
    }
  }
}