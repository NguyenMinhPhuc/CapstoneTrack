/**
 * @file Overview
 * This ruleset enforces a role-based access control model, where users can only access their own data unless they have admin privileges.
 * Data Structure:
 * - /users/{userId}: Stores user account information.
 * - /students/{studentId}: Stores student information.
 * - /supervisors/{supervisorId}: Stores supervisor information.
 * - /graduationDefenseSessions/{sessionId}: Stores information about graduation defense sessions.
 * - /graduationDefenseSessions/{sessionId}/registrations/{registrationId}: Stores student registrations for a specific defense session.
 * Key Security Decisions:
 * - Users can only read and write their own user documents.
 * - Only authenticated users can access student and supervisor data.
 * - Graduation defense sessions are publicly readable, but only admins can modify them.
 * - Registrations are accessible only with the right user role.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user account information.
     * @path /users/{userId}
     * @allow (get, update, delete) if the user is the owner of the document.
     * @allow (create) if the user id is the same as auth id.
     * @deny If the user is not the owner of the document, creation user id isn't the same as auth id, the role is not admin, or they are trying to list all users.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      function isSignedIn() {
        return request.auth != null;
      }
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Controls access to student information.
     * @path /students/{studentId}
     * @allow (get, list) if the user is signed in.
     * @allow (create) if the studentId matches the authenticated user's ID.
     * @allow (update, delete) if the studentId matches the authenticated user's ID and the document exists.
     * @deny If the user is not signed in, or trying to modify another student's data.
     * @principle Enforces document ownership for writes.
     */
    match /students/{studentId} {
      function isOwner(studentId) {
        return request.auth.uid == studentId;
      }
      function isSignedIn() {
        return request.auth != null;
      }
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn() && request.auth.uid == studentId;
      allow update: if isSignedIn() && isOwner(studentId);
      allow delete: if isOwner(studentId);
    }

    /**
     * @description Controls access to supervisor information.
     * @path /supervisors/{supervisorId}
     * @allow (get, list) if the user is signed in.
     * @allow (create) if the supervisorId matches the authenticated user's ID.
     * @allow (update, delete) if the supervisorId matches the authenticated user's ID and the document exists.
     * @deny If the user is not signed in, or trying to modify another supervisor's data.
     * @principle Enforces document ownership for writes.
     */
    match /supervisors/{supervisorId} {
      function isOwner(supervisorId) {
        return request.auth.uid == supervisorId;
      }
      function isSignedIn() {
        return request.auth != null;
      }
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn() && request.auth.uid == supervisorId;
      allow update: if isOwner(supervisorId);
      allow delete: if isOwner(supervisorId);
    }

    /**
     * @description Controls access to graduation defense session information.
     * @path /graduationDefenseSessions/{sessionId}
     * @allow (get, list) Public read access.
     * @allow (create, update, delete) if the user is an admin.
     * @deny If the user is not an admin and is trying to modify the session.
     * @principle Public read access with admin-controlled writes.
     */
    match /graduationDefenseSessions/{sessionId} {
      function isAdmin() {
        return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      }
      allow get, list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Controls access to defense registrations.
     * @path /graduationDefenseSessions/{sessionId}/registrations/{registrationId}
     * @allow (get, list) if the user is an admin or the student who created the registration.
     * @allow (create) if the user is signed in and the studentId in the registration matches the authenticated user's ID.
     * @allow (update, delete) if the user is an admin or the student who created the registration, and the document exists.
     * @deny If the user is not an admin or the student who created the registration, or if they are trying to modify another student's registration.
     * @principle Enforces document ownership for writes.
     */
    match /graduationDefenseSessions/{sessionId}/registrations/{registrationId} {
      function isOwner(studentId) {
        return request.auth.uid == studentId;
      }
      function isAdmin() {
        return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      }
      function isSignedIn() {
        return request.auth != null;
      }
      allow get, list: if isAdmin() || (isSignedIn() && resource.data.studentId == request.auth.uid);
      allow create: if isSignedIn() && request.resource.data.studentId == request.auth.uid;
      allow update: if isAdmin() || (isSignedIn() && request.resource.data.studentId == request.auth.uid);
      allow delete: if isAdmin() || (isSignedIn() && request.resource.data.studentId == request.auth.uid);
    }
  }
}