/**
 * @file Firebase Security Rules for Firestore.
 *
 * @core_philosophy This ruleset enforces a shared access model for conversations,
 *  where participants can read and write to conversation threads and associated messages.
 *  It also allows any signed-in user to create a conversation.
 * @data_structure
 *  /conversations/{conversationId} - Stores conversation metadata.
 *  /conversations/{conversationId}/messages/{messageId} - Stores messages within a conversation.
 * @key_security_decisions
 *  - Conversation listing is disallowed to prevent unauthorized data access. Only participants can see a conversation.
 *  - Data validation is relaxed during the prototyping phase.
 *  - Relational integrity is enforced on message creation to link messages to their parent conversations.
 *  - Conversations are created when a user messages another.
 *  - Everyone is denied update or delete permissions.
 *  - Only participants are granted access to read the data.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isParticipant(conversationId) {
        return isSignedIn() && get(/databases/$(database)/documents/conversations/$(conversationId)).data.participantIds.hasAny([request.auth.uid]);
    }

    /**
     * @description Controls access to the /conversations collection.
     * @path /conversations/{conversationId}
     * @allow (create) - Any signed-in user can create a conversation.
     * @deny (create) - Conversation creation fails if the conversation document already exists.
     * @allow (get) - Only a participant of the conversation can read it.
     * @deny (get) - A non-participant cannot read the conversation.
     * @deny (list) - Listing conversations is disallowed.
     * @allow (update) - No one is allowed to update the document.
     * @allow (delete) - No one is allowed to delete the document.
     * @principle Enforces shared access to conversations: only participants can access.
     */
    match /conversations/{conversationId} {
      allow create: if isSignedIn();
      allow get: if isParticipant(conversationId);
      allow list: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Controls access to the /conversations/{conversationId}/messages subcollection.
     * @path /conversations/{conversationId}/messages/{messageId}
     * @allow (create) - Only a participant of the conversation can create a message.  The conversationId must match.
     * @deny (create) - Message creation fails if the user is not a participant.
     * @allow (get) - Only a participant of the conversation can read a message.
     * @deny (get) - A non-participant cannot read the message.
     * @allow (list) - Only a participant of the conversation can list messages.
     * @deny (list) - A non-participant cannot list messages.
     * @allow (update) - No one is allowed to update the document.
     * @allow (delete) - No one is allowed to delete the document.
     * @principle Enforces shared access to messages within a conversation: only participants can access.
     */
    match /conversations/{conversationId}/messages/{messageId} {
      allow create: if isParticipant(conversationId) && request.resource.data.conversationId == conversationId;
      allow get: if isParticipant(conversationId);
      allow list: if isParticipant(conversationId);
      allow update: if false;
      allow delete: if false;
    }
  }
}