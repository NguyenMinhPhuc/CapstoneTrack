rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user account documents.
     * @path /users/{userId}
     * @allow (create) User with UID 'testUID' can create their own user document.
     * @allow (get, update, delete) User with UID 'testUID' can read, update, and delete their own user document.
     * @deny (create) User with UID 'testUID' cannot create a user document with a different userId.
     * @deny (get, update, delete) User with UID 'anotherUID' cannot read, update, or delete the user document of user 'testUID'.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isSignedIn() && resource.data.keys().hasAll(['id']) && resource != null && isOwner(userId);
      }

      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to student documents.
     * @path /students/{studentId}
     * @allow (create) User with UID 'testUID' can create their own student document.
     * @allow (get, update, delete) User with UID 'testUID' can read, update, and delete their own student document.
     * @deny (create) User with UID 'testUID' cannot create a student document with a different studentId.
     * @deny (get, update, delete) User with UID 'anotherUID' cannot read, update, or delete the student document of user 'testUID'.
     * @principle Enforces document ownership for all operations.
     */
    match /students/{studentId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(studentId) {
        return request.auth.uid == studentId;
      }

      function isExistingOwner(studentId) {
        return isSignedIn() && resource.data.keys().hasAll(['id']) && resource != null && isOwner(studentId);
      }

      allow get: if isSignedIn() && isOwner(studentId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(studentId);
      allow update: if isExistingOwner(studentId);
      allow delete: if isExistingOwner(studentId);
    }

    /**
     * @description Controls access to supervisor documents.
     * @path /supervisors/{supervisorId}
     * @allow (create) User with UID 'testUID' can create their own supervisor document.
     * @allow (get, update, delete) User with UID 'testUID' can read, update, and delete their own supervisor document.
     * @deny (create) User with UID 'testUID' cannot create a supervisor document with a different supervisorId.
     * @deny (get, update, delete) User with UID 'anotherUID' cannot read, update, or delete the supervisor document of user 'testUID'.
     * @principle Enforces document ownership for all operations.
     */
    match /supervisors/{supervisorId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(supervisorId) {
        return request.auth.uid == supervisorId;
      }

      function isExistingOwner(supervisorId) {
        return isSignedIn() && resource.data.keys().hasAll(['id']) && resource != null && isOwner(supervisorId);
      }

      allow get: if isSignedIn() && isOwner(supervisorId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(supervisorId);
      allow update: if isExistingOwner(supervisorId);
      allow delete: if isExistingOwner(supervisorId);
    }
  }
}