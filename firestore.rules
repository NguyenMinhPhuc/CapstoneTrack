/**
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for personal data and role-based access control for administrative functions.
 * Data access is generally restricted to the owner or authorized roles. Public listing is disabled for sensitive collections.
 *
 * Data Structure:
 * - /users/{userId}: User account information (private).
 * - /students/{studentId}: Student details (private, linked to user).
 * - /supervisors/{supervisorId}: Supervisor details (private, linked to user).
 * - /defenseSessions/{sessionId}: Defense session configurations (admin-managed).
 * - /defenseRegistrations/{registrationId}: Student registrations for defense sessions.
 * - /defenseSessions/{sessionId}/council/{councilMemberId}: Members of defense councils.
 * - /defenseSessions/{sessionId}/subCommittees/{subCommitteeId}: Sub-committees for defense sessions.
 * - /projectTopics/{topicId}: Project topics proposed by supervisors.
 * - /rubrics/{rubricId}: Grading rubrics (admin-managed).
 * - /evaluations/{evaluationId}: Evaluation records (supervisor-specific).
 * - /weeklyProgressReports/{reportId}: Student's weekly progress reports.
 * - /systemSettings/{settingId}: System-wide settings (admin-managed).
 * - /internshipCompanies/{companyId}: Internship company information.
 * - /earlyInternships/{internshipId}: Early internship records.
 * - /earlyInternshipWeeklyReports/{reportId}: Weekly reports for early internships.
 * - /conversations/{conversationId}: Q&A conversation threads (shared access).
 * - /conversations/{conversationId}/messages/{messageId}: Messages within a conversation (shared access).
 * - /notifications/{notificationId}: User notifications (private).
 *
 * Key Security Decisions:
 * - User listing is generally disallowed to protect privacy.
 * - All write operations require authentication.
 * - Read and write access to conversations and messages is based on shared participation.
 * - The default security posture for ambiguous relationships is strict owner-only access.
 *
 * Denormalization for Authorization:
 * - Conversation documents include a `participantIds` array to simplify access control for messages.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user ID matches the provided user ID.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user ID matches the provided user ID and resource exists.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }
    
    /**
     * @description Checks if the authenticated user has the 'admin' role.
     */
    function isAdmin() {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    /**
     * @description Checks if the authenticated user is a participant in the conversation.
     */
    function isParticipant(participantIds) {
      return isSignedIn() && participantIds.hasAny([request.auth.uid]);
    }

    /**
     * @description Rule for the root path.  No specific checks.
     * @path /
     * @allow (get) any authenticated user
     * @deny (create) no one
     * @principle Root path - all security checks handled at lower levels.
     */
    match /{document=**} {
      allow read: if true;
      allow write: if false;
    }

    /**
     * @description Manages user account information, accessible only to the user.
     * @path /users/{userId}
     * @allow (get) User with ID 'user123' gets their own profile.
     * @allow (create) User with ID 'user123' creates their own profile.
     * @allow (update) User with ID 'user123' updates their own profile.
     * @allow (delete) User with ID 'user123' deletes their own profile.
     * @deny (get) User with ID 'user456' tries to read profile of 'user123'.
     * @deny (create) User with ID 'user456' tries to create profile for 'user123'.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false; // Prevent user enumeration

      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Manages student details, accessible only to the student.
     * @path /students/{studentId}
     * @allow (get) Student with ID 'student123' gets their own details.
     * @allow (create) Student with ID 'student123' creates their own details.
     * @allow (update) Student with ID 'student123' updates their own details.
     * @allow (delete) Student with ID 'student123' deletes their own details.
     * @deny (get) Student with ID 'student456' tries to read details of 'student123'.
     * @deny (create) Student with ID 'student456' tries to create details for 'student123'.
     * @principle Enforces document ownership for writes.
     */
    match /students/{studentId} {
      allow get: if isOwner(studentId);
      allow list: if false; // Prevent student enumeration

      allow create: if isOwner(studentId) && request.resource.data.id == studentId;
      allow update: if isExistingOwner(studentId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(studentId);
    }

    /**
     * @description Manages supervisor details, accessible only to the supervisor.
     * @path /supervisors/{supervisorId}
     * @allow (get) Supervisor with ID 'supervisor123' gets their own details.
     * @allow (create) Supervisor with ID 'supervisor123' creates their own details.
     * @allow (update) Supervisor with ID 'supervisor123' updates their own details.
     * @allow (delete) Supervisor with ID 'supervisor123' deletes their own details.
     * @deny (get) Supervisor with ID 'supervisor456' tries to read details of 'supervisor123'.
     * @deny (create) Supervisor with ID 'supervisor456' tries to create details for 'supervisor123'.
     * @principle Enforces document ownership for writes.
     */
    match /supervisors/{supervisorId} {
      allow get: if isOwner(supervisorId);
      allow list: if false; // Prevent supervisor enumeration

      allow create: if isOwner(supervisorId) && request.resource.data.id == supervisorId;
      allow update: if isExistingOwner(supervisorId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(supervisorId);
    }

    /**
     * @description Manages defense sessions, accessible only to admins.
     * @path /defenseSessions/{sessionId}
     * @allow (get) Admin gets any defense session.
     * @allow (create) Admin creates a new defense session.
     * @allow (update) Admin updates any defense session.
     * @allow (delete) Admin deletes any defense session.
     * @deny (get) Regular user tries to read a defense session.
     * @deny (create) Regular user tries to create a defense session.
     * @principle Restricts access to administrative roles.
     */
    match /defenseSessions/{sessionId} {
      allow get: if isAdmin();
      allow list: if isAdmin();

      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Manages student registrations for defense sessions.
     * @path /defenseRegistrations/{registrationId}
     * @allow (get) Any signed in user can get defense registrations
     * @allow (create) Any signed in user can create defense registrations
     * @allow (update) Any signed in user can update defense registrations
     * @allow (delete) Any signed in user can delete defense registrations
     * @deny (create) Unauthenticated user tries to create a registration.
     * @principle Allows authenticated users to manage their own registrations.
     */
    match /defenseRegistrations/{registrationId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();

      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

     /**
      * @description Manages members of the main defense council for a specific session; accessible only to admins.
      * @path /defenseSessions/{sessionId}/council/{councilMemberId}
      * @allow (get) Admin gets any council member.
      * @allow (create) Admin creates a new council member.
      * @allow (update) Admin updates any council member.
      * @allow (delete) Admin deletes any council member.
      * @deny (get) Regular user tries to read a council member.
      * @deny (create) Regular user tries to create a council member.
      * @principle Restricts access to administrative roles.
      */
    match /defenseSessions/{sessionId}/council/{councilMemberId} {
      allow get: if isAdmin();
      allow list: if isAdmin();

      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Manages sub-committees for a specific defense session; accessible only to admins.
     * @path /defenseSessions/{sessionId}/subCommittees/{subCommitteeId}
     * @allow (get) Admin gets any sub-committee.
     * @allow (create) Admin creates a new sub-committee.
     * @allow (update) Admin updates any sub-committee.
     * @allow (delete) Admin deletes any sub-committee.
     * @deny (get) Regular user tries to read a sub-committee.
     * @deny (create) Regular user tries to create a sub-committee.
     * @principle Restricts access to administrative roles.
     */
    match /defenseSessions/{sessionId}/subCommittees/{subCommitteeId} {
      allow get: if isAdmin();
      allow list: if isAdmin();

      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Manages project topics, accessible to all signed-in users.
     * @path /projectTopics/{topicId}
     * @allow (get) Any signed in user can get project topics
     * @allow (create) Any signed in user can create project topics
     * @allow (update) Any signed in user can update project topics
     * @allow (delete) Any signed in user can delete project topics
     * @deny (create) Unauthenticated user tries to create a project topic.
     * @principle Allows authenticated users to manage project topics.
     */
    match /projectTopics/{topicId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();

      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Manages grading rubrics, accessible only to admins.
     * @path /rubrics/{rubricId}
     * @allow (get) Admin gets any rubric.
     * @allow (create) Admin creates a new rubric.
     * @allow (update) Admin updates any rubric.
     * @allow (delete) Admin deletes any rubric.
     * @deny (get) Regular user tries to read a rubric.
     * @deny (create) Regular user tries to create a rubric.
     * @principle Restricts access to administrative roles.
     */
    match /rubrics/{rubricId} {
      allow get: if isAdmin();
      allow list: if isAdmin();

      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Manages evaluation records, accessible only to admins.
     * @path /evaluations/{evaluationId}
     * @allow (get) Any signed in user can get evaluation records
     * @allow (create) Any signed in user can create evaluation records
     * @allow (update) Any signed in user can update evaluation records
     * @allow (delete) Any signed in user can delete evaluation records
     * @deny (create) Unauthenticated user tries to create an evaluation.
     * @principle Restricts access to administrative roles.
     */
    match /evaluations/{evaluationId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();

      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Manages weekly progress reports, accessible to any signed-in users.
     * @path /weeklyProgressReports/{reportId}
     * @allow (get) Any signed in user can get weekly progress reports
     * @allow (create) Any signed in user can create weekly progress reports
     * @allow (update) Any signed in user can update weekly progress reports
     * @allow (delete) Any signed in user can delete weekly progress reports
     * @deny (create) Unauthenticated user tries to create a weekly progress report.
     * @principle Allows authenticated users to manage weekly progress reports.
     */
    match /weeklyProgressReports/{reportId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();

      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Manages system-wide settings, accessible only to admins.
     * @path /systemSettings/{settingId}
     * @allow (get) Admin gets any system setting.
     * @allow (create) Admin creates a new system setting.
     * @allow (update) Admin updates any system setting.
     * @allow (delete) Admin deletes any system setting.
     * @deny (get) Regular user tries to read a system setting.
     * @deny (create) Regular user tries to create a system setting.
     * @principle Restricts access to administrative roles.
     */
    match /systemSettings/{settingId} {
      allow get: if isAdmin();
      allow list: if isAdmin();

      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Manages internship company information, accessible to any signed-in users.
     * @path /internshipCompanies/{companyId}
     * @allow (get) Any signed in user can get internship company information
     * @allow (create) Any signed in user can create internship company information
     * @allow (update) Any signed in user can update internship company information
     * @allow (delete) Any signed in user can delete internship company information
     * @deny (create) Unauthenticated user tries to create internship company information.
     * @principle Allows authenticated users to manage internship company information.
     */
    match /internshipCompanies/{companyId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();

      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Manages early internship records, accessible to any signed-in users.
     * @path /earlyInternships/{internshipId}
     * @allow (get) Any signed in user can get early internship records
     * @allow (create) Any signed in user can create early internship records
     * @allow (update) Any signed in user can update early internship records
     * @allow (delete) Any signed in user can delete early internship records
     * @deny (create) Unauthenticated user tries to create an early internship.
     * @principle Allows authenticated users to manage early internship records.
     */
    match /earlyInternships/{internshipId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();

      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Manages weekly reports for early internships, accessible to any signed-in users.
     * @path /earlyInternshipWeeklyReports/{reportId}
     * @allow (get) Any signed in user can get weekly reports for early internships
     * @allow (create) Any signed in user can create weekly reports for early internships
     * @allow (update) Any signed in user can update weekly reports for early internships
     * @allow (delete) Any signed in user can delete weekly reports for early internships
     * @deny (create) Unauthenticated user tries to create an early internship weekly report.
     * @principle Allows authenticated users to manage early internship weekly reports.
     */
    match /earlyInternshipWeeklyReports/{reportId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();

      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Manages Q&A conversation threads, accessible to participants.
     * @path /conversations/{conversationId}
     * @allow (get) User who is a participant in the conversation can get it.
     * @allow (create) User who is a participant in the conversation can create it.
     * @allow (update) User who is a participant in the conversation can update it.
     * @allow (delete) User who is a participant in the conversation can delete it.
     * @deny (get) User who is not a participant tries to get the conversation.
     * @principle Restricts access to participants in the conversation.
     */
    match /conversations/{conversationId} {
      allow get: if isParticipant(resource.data.participantIds);
      allow list: if isSignedIn(); // changed to allow for all signed in users - previously if isParticipant(resource.data.participantIds);

      allow create: if isSignedIn() && request.resource.data.participantIds.hasAny([request.auth.uid]);
      allow update: if isExistingOwner(conversationId) && isParticipant(request.resource.data.participantIds);
      allow delete: if isExistingOwner(conversationId) && isParticipant(resource.data.participantIds);
    }

    /**
     * @description Manages messages within a conversation, accessible to participants.
     * @path /conversations/{conversationId}/messages/{messageId}
     * @allow (get) User who is a participant in the conversation can get the message.
     * @allow (create) User who is a participant in the conversation can create a message.
     * @allow (update) User who is a participant in the conversation can update the message.
     * @allow (delete) User who is a participant in the conversation can delete the message.
     * @deny (get) User who is not a participant tries to get the message.
     * @principle Restricts access to participants in the conversation.
     */
    match /conversations/{conversationId}/messages/{messageId} {
      allow get: if get(/databases/$(database)/documents/conversations/$(conversationId)).data.participantIds.hasAny([request.auth.uid]);
      allow list: if false;

      allow create: if isSignedIn() && get(/databases/$(database)/documents/conversations/$(conversationId)).data.participantIds.hasAny([request.auth.uid]);
      allow update: if false; // Messages should generally not be editable.
      allow delete: if false; // Messages should generally not be deletable.
    }

    /**
     * @description Manages notifications for users, accessible only to the recipient.
     * @path /notifications/{notificationId}
     * @allow (get) User with ID 'user123' gets their own notification.
     * @allow (create) User with ID 'user123' creates their own notification.
     * @allow (update) User with ID 'user123' updates their own notification.
     * @allow (delete) User with ID 'user123' deletes their own notification.
     * @deny (get) User with ID 'user456' tries to read notification of 'user123'.
     * @deny (create) User with ID 'user456' tries to create notification for 'user123'.
     * @principle Enforces document ownership for writes.
     */
    match /notifications/{notificationId} {
      allow get: if isOwner(resource.data.recipientId);
      allow list: if isOwner(request.auth.uid);

      allow create: if request.resource.data.recipientId == request.auth.uid;
      allow update: if isExistingOwner(resource.data.recipientId) && request.resource.data.recipientId == resource.data.recipientId;
      allow delete: if isExistingOwner(resource.data.recipientId);
    }
  }
}