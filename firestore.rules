/**
 * @file Firebase Security Rules for CapstoneTrack Firestore database.
 *
 * Core Philosophy:
 * This ruleset implements a role-based access control system, combined with
 * ownership checks for user-specific data.  Admin users have full access,
 * supervisors can manage their own profiles, and students primarily access
 * their own information.
 *
 * Data Structure:
 * - /users/{userId}: Stores user account information; access controlled by role and ownership.
 * - /students/{studentId}: Stores student profiles; accessible to admins and the student themselves.
 * - /supervisors/{supervisorId}: Stores supervisor profiles; accessible to admins and the supervisor themselves.
 * - /graduationDefenseSessions/{sessionId}: Stores information about defense sessions; publicly readable, but create/update/delete restricted to admins.
 * - /graduationDefenseSessions/{sessionId}/registrations/{registrationId}: Stores student registrations; create/update/delete restricted to admins, readable by session admins.
 *
 * Key Security Decisions:
 * - User listing is denied to prevent unauthorized information gathering.
 * - Data validation is relaxed to allow for rapid prototyping.  Critical authorization fields are still validated.
 * - get operations are permitted to allow retrieving non-existent documents, so the backend can return a 404.
 * - All write operations are validated to confirm the document exists.
 *
 * Denormalization for Authorization:
 *   To simplify rules and avoid costly `get()` operations, authorization data such as user roles and ownership are denormalized directly onto the documents. For example, student and supervisor documents are linked to user accounts via `studentId` and `supervisorId` respectively to allow owner validation.
 *
 * Structural Segregation:
 *   No structural segregation is necessary as private user data and public data are stored in different collections and subcollections with clearly defined access control.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Manages user account information, restricting access based on role and ownership.
     * @path /users/{userId}
     * @allow (create) - User with matching {userId} can create their own record.
     * @allow (get, list) - Admins can read all user accounts. Users can only read their own account.
     * @allow (update, delete) - Admins can update or delete any user account. Users can update their own account.
     * @deny (create) - User cannot create a record with mismatched {userId}.
     * @deny (update, delete) - User cannot update or delete another user's account.
     * @principle Enforces user ownership and admin role-based access.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isAdmin() {
        return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      }
      
      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isAdmin() || isOwner(userId);
      allow list: if false;

      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) || isAdmin() && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId) || isAdmin();
    }

    /**
     * @description Manages student profiles, allowing access to admins and the student themselves.
     * @path /students/{studentId}
     * @allow (create) - Admins can create student profiles. Students can create their own profile with matching {studentId}.
     * @allow (get, list) - Admins can read all student profiles. Students can only read their own profile.
     * @allow (update, delete) - Admins can update or delete any student profile. Students can update their own profile.
     * @deny (create) - User cannot create a student profile with mismatched {studentId}.
     * @deny (update, delete) - User cannot update or delete another student's profile.
     * @principle Enforces student ownership and admin role-based access.
     */
    match /students/{studentId} {
        function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(studentId) {
        return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.studentId == studentId;
      }

      function isAdmin() {
        return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      }
        function isExistingOwner(studentId) {
        return isOwner(studentId) && resource != null;
      }


      allow get: if isAdmin() || isOwner(studentId);
      allow list: if isAdmin();
      allow create: if isAdmin() || (isOwner(studentId) && request.resource.data.id == studentId);
      allow update: if isExistingOwner(studentId) || isAdmin() && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(studentId) || isAdmin();
    }

    /**
     * @description Manages supervisor profiles, allowing access to admins and the supervisor themselves.
     * @path /supervisors/{supervisorId}
     * @allow (create) - Admins can create supervisor profiles. Supervisors can create their own profile with matching {supervisorId}.
     * @allow (get, list) - Admins can read all supervisor profiles. Supervisors can only read their own profile.
     * @allow (update, delete) - Admins can update or delete any supervisor profile. Supervisors can update their own profile.
     * @deny (create) - User cannot create a supervisor profile with mismatched {supervisorId}.
     * @deny (update, delete) - User cannot update or delete another supervisor's profile.
     * @principle Enforces supervisor ownership and admin role-based access.
     */
    match /supervisors/{supervisorId} {
          function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(supervisorId) {
        return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.supervisorId == supervisorId;
      }

      function isAdmin() {
        return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      }
        function isExistingOwner(supervisorId) {
        return isOwner(supervisorId) && resource != null;
      }


      allow get: if isAdmin() || isOwner(supervisorId);
      allow list: if isAdmin();
      allow create: if isAdmin() || (isOwner(supervisorId) && request.resource.data.id == supervisorId);
      allow update: if isExistingOwner(supervisorId) || isAdmin() && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(supervisorId) || isAdmin();
    }

    /**
     * @description Manages graduation defense sessions, restricting write access to admins.
     * @path /graduationDefenseSessions/{sessionId}
     * @allow (get, list) - Everyone can view graduation defense sessions.
     * @allow (create, update, delete) - Only admins can create, update, or delete sessions.
     * @deny (create, update, delete) - Non-admins cannot create, update, or delete sessions.
     * @principle Enforces admin-only control for session management.
     */
    match /graduationDefenseSessions/{sessionId} {
          function isSignedIn() {
        return request.auth != null;
      }

      function isAdmin() {
        return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      }
        function isExistingDocument() {
        return resource != null;
      }


      allow get, list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin() && isExistingDocument();
      allow delete: if isAdmin() && isExistingDocument();
    }

    /**
     * @description Manages student registrations for a specific defense session, restricting write access to admins.
     * @path /graduationDefenseSessions/{sessionId}/registrations/{registrationId}
     * @allow (get, list) - Admins can read all registrations. Students can only read their own registration.
     * @allow (create, update, delete) - Only admins can create, update, or delete registrations.
     * @deny (create, update, delete) - Non-admins cannot create, update, or delete registrations.
     * @principle Enforces admin-only control for registration management.
     */
    match /graduationDefenseSessions/{sessionId}/registrations/{registrationId} {
          function isSignedIn() {
        return request.auth != null;
      }

      function isAdmin() {
        return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      }
      
       function isExistingDocument() {
        return resource != null;
      }
      
      allow get, list: if isAdmin();
      allow create: if isAdmin();
      allow update: if isAdmin() && isExistingDocument();
      allow delete: if isAdmin() && isExistingDocument();
    }
  }
}