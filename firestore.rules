/**
 * @fileoverview Firestore Security Rules for CapstoneTrack System
 *
 * Core Philosophy:
 * This ruleset enforces a user-ownership model for user accounts, students, and supervisors.
 * Users can only access their own data, with no listing of all users permitted.
 *
 * Data Structure:
 * - /users/{userId}: Stores user account information, secured by user ID.
 * - /students/{studentId}: Stores student profiles, secured by student ID.
 * - /supervisors/{supervisorId}: Stores supervisor profiles, secured by supervisor ID.
 *
 * Key Security Decisions:
 * - Users can only create their own user account.
 * - Listing of users, students, and supervisors is disallowed for privacy.
 * - The rules default to strict owner-only access unless explicitly overridden.
 *
 * Denormalization for Authorization:
 *  N/A - Current Rules do not utilize denormalization.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Manages user account information.
     * @path /users/{userId}
     * @allow (create) - User with UID 'user123' can create a document with ID 'user123'.
     * @deny (create) - User with UID 'user456' cannot create a document with ID 'user123'.
     * @allow (get, update, delete) - User with UID 'user123' can read/write a document with ID 'user123'.
     * @deny (get, update, delete) - User with UID 'user456' cannot read/write a document with ID 'user123'.
     * @principle Enforces document ownership, allowing users to manage their own account data.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Manages student profiles.
     * @path /students/{studentId}
     * @allow (create) - User with UID matching studentId can create a student profile.
     * @deny (create) - User with UID not matching studentId cannot create a student profile.
     * @allow (get, update, delete) - User with UID matching studentId can read/write their student profile.
     * @deny (get, update, delete) - User with UID not matching studentId cannot read/write another's student profile.
     * @principle Enforces document ownership, allowing students to manage their own profiles.
     */
    match /students/{studentId} {
        function isSignedIn() {
            return request.auth != null;
        }

        function isOwner(studentId) {
            return request.auth.uid == studentId;
        }

        function isExistingOwner(studentId) {
            return isOwner(studentId) && resource != null;
        }

        allow get: if isOwner(studentId);
        allow list: if false;
        allow create: if isSignedIn() && isOwner(studentId);
        allow update: if isExistingOwner(studentId);
        allow delete: if isExistingOwner(studentId);
    }

    /**
     * @description Manages supervisor profiles.
     * @path /supervisors/{supervisorId}
     * @allow (create) - User with UID matching supervisorId can create a supervisor profile.
     * @deny (create) - User with UID not matching supervisorId cannot create a supervisor profile.
     * @allow (get, update, delete) - User with UID matching supervisorId can read/write their supervisor profile.
     * @deny (get, update, delete) - User with UID not matching supervisorId cannot read/write another's supervisor profile.
     * @principle Enforces document ownership, allowing supervisors to manage their own profiles.
     */
    match /supervisors/{supervisorId} {
        function isSignedIn() {
            return request.auth != null;
        }

        function isOwner(supervisorId) {
            return request.auth.uid == supervisorId;
        }

        function isExistingOwner(supervisorId) {
            return isOwner(supervisorId) && resource != null;
        }

        allow get: if isOwner(supervisorId);
        allow list: if false;
        allow create: if isSignedIn() && isOwner(supervisorId);
        allow update: if isExistingOwner(supervisorId);
        allow delete: if isExistingOwner(supervisorId);
    }
  }
}